<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>External Attack Surface Analysis</title>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Root CSS variables for theme colors and font sizes */
      :root {
        /* Light theme colors */
        --light-bg-color: #f9f9f9;
        --light-text-color: #333;
        --light-header-bg: #fff;
        --light-header-text: #333;
        --light-table-bg: #fff;
        --light-table-header-bg: #eee;
        --light-table-border: #ddd;
        --light-toggle-bg: #757574;
        --light-toggle-btn: #fff;
        /* Dark theme colors */
        --dark-bg-color: #1f1f1f;
        --dark-text-color: #f0f0f0;
        --dark-header-bg: #2a2a2a;
        --dark-header-text: #ffffff;
        --dark-table-bg: #2a2a2a;
        --dark-table-header-bg: #3a3a3a;
        --dark-table-border: #444;
        --dark-toggle-bg: #555;
        --dark-toggle-btn: #ffffff;
        /* Active theme variables (default to light) */
        --bg-color: var(--light-bg-color);
        --text-color: var(--light-text-color);
        --header-bg: var(--light-header-bg);
        --header-text: var(--light-header-text);
        --table-bg: var(--light-table-bg);
        --table-header-bg: var(--light-table-header-bg);
        --table-border: var(--light-table-border);
        --toggle-bg: var(--light-toggle-bg);
        --toggle-btn: var(--light-toggle-btn);
        /* Font sizing variables */
        --font-size-sm: 12px;
        --font-size-base: 13px;
        --font-size-md: 14px;
        --font-size-lg: 16px;
        --heading-font-size: 22px;
      }
      /* Dark theme override */
      body.dark {
        --bg-color: var(--dark-bg-color);
        --text-color: var(--dark-text-color);
        --header-bg: var(--dark-header-bg);
        --header-text: var(--dark-header-text);
        --table-bg: var(--dark-table-bg);
        --table-header-bg: var(--dark-table-header-bg);
        --table-border: var(--dark-table-border);
        --toggle-bg: var(--dark-toggle-bg);
        --toggle-btn: var(--dark-toggle-btn);
      }
      /* Basic styles for body and fonts */
      body {
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: var(--font-size-base);
        line-height: 1.4;
      }
      /* HEADER styles */
      .header {
        position: relative;
        background-color: var(--header-bg);
        color: var(--header-text);
        text-align: center;
        padding: 12px 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .table-container {
        width: 100%;
        max-height: 500px;
        overflow-x: auto;
        overflow-y: auto;
        margin-top: 10px;
      }
      .header h1 {
        margin: 0;
      }
      .toggle-btn, .csv-btn {
        position: absolute;
        background-color: var(--toggle-bg);
        border: none;
        color: var(--toggle-btn);
        cursor: pointer;
        border-radius: 4px;
        font-size: var(--font-size-md);
      }
      .toggle-btn {
        right: 20px;
        top: 12px;
        transition: background-color 0.2s, color 0.2s;
      }
      .csv-btn {
        right: 20px;
        top: 35px;
        transition: background-color 0.5s, color 0.2s;
      }
      .toggle-btn:hover {
        opacity: 0.9;
      }
      /* Top controls for table filters and pagination */
      .table-top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      /* Container for the entire report */
      .container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      /* Scoreboard styles for summary cards */
      .scoreboard {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }
      .score-card {
        background-color: var(--table-bg);
        border: 1px solid var(--table-border);
        border-radius: 5px;
        flex: 1 1 200px;
        padding: 10px;
        text-align: center;
      }
      .score-card h2 {
        margin: 0;
        font-size: 1.6em;
        font-weight: 500;
      }
      .score-card p {
        margin: 5px 0 0;
        font-size: var(--font-size-sm);
        color: var(--text-color);
      }
      .hint {
        color: red;
      }
      /* Grid layout for charts */
      .charts-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        margin-bottom: 20px;
      }
      .chart-container {
        position: relative;
        background-color: var(--table-bg);
        border: 1px solid var(--table-border);
        border-radius: 5px;
        padding: 10px;
        box-sizing: border-box;
      }
      .chart-container canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }
      /* Search box styling */
      #searchBox {
        margin: 0;
        padding: 6px 10px;
        width: 250px;
        font-size: var(--font-size-sm);
        border: 1px solid var(--table-border);
        border-radius: 4px;
      }
      /* Table controls styling */
      .table-controls {
        margin: 0;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
      .table-controls label {
        margin-right: 6px;
        font-size: var(--font-size-sm);
      }
      .table-controls select {
        font-size: var(--font-size-sm);
        padding: 4px 8px;
        border: 1px solid var(--table-border);
        border-radius: 4px;
        background-color: var(--table-bg);
        color: var(--text-color);
      }
      /* Main table styling */
      table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        background-color: var(--table-bg);
        font-size: var(--font-size-sm);
      }
      table thead tr {
        position: sticky;
        z-index: 10;
        background-color: var(--table-header-bg);
      }
      table thead tr:first-child {
        top: 0;
      }
      table thead tr:nth-child(2) {
        top: 61px;
      }
      th, td {
        border: 1px solid var(--table-border);
        padding: 8px;
        text-align: left;
        vertical-align: top;
        color: inherit;
      }
      th {
        background-color: var(--table-header-bg);
        font-weight: 600;
      }
      /* Filter dropdown styling in table header */
      #filter-row select {
        width: 100%;
        font-size: var(--font-size-sm);
        padding: 2px 4px;
        border: 1px solid var(--table-border);
        border-radius: 3px;
        background-color: var(--table-bg);
        color: var(--text-color);
      }
      /* Pagination controls styling */
      #paginationControls {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      #paginationControls button {
        padding: 6px 12px;
        cursor: pointer;
        font-size: var(--font-size-sm);
        border-radius: 4px;
        border: 1px solid var(--table-border);
        background-color: var(--toggle-bg);
        color: var(--toggle-btn);
        transition: background-color 0.2s, color 0.2s;
      }
      #paginationControls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      /* Ensure proper display for the last header column */
      th:nth-child(33) {
        white-space: nowrap;
      }
      /* Thumbnail styling for screenshots */
      .thumbnail {
        width: 150px;
        height: 150px;
        cursor: pointer;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      /* Modal styling */
      #screenshotModal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.75);
      }
      #screenshotModalContent {
        position: relative;
        margin: 5% auto;
        width: 80%;
        max-width: 900px;
        background-color: #fff;
        padding: 10px;
        border-radius: 4px;
      }
      #screenshotModalImg {
        width: 100%;
        height: auto;
        display: block;
      }
      #closeModalBtn {
        position: absolute;
        top: 5px;
        right: 10px;
        background: #444;
        color: #fff;
        border: none;
        border-radius: 3px;
        padding: 5px 8px;
        cursor: pointer;
      }
    </style>
    <!-- Global screenshot map definition -->
    <!-- Screenshot map placeholder; the actual data will be inserted by the build_html_report function -->
    <script>
      // The screenshot map data will be injected below:
      const screenshotMap =
      %%SCREENSHOT_MAP%%
      ;
    </script>


  </head>
  <body>
    <!-- Header section with title and theme toggle button -->
    <div class="header">
      <h1>External Attack Surface Analysis Report</h1>
      <button id="themeToggle" class="toggle-btn">DARK THEME</button>
      <button id="exportCsvButton" class="csv-btn">EXPORT CSV</button>
    </div>
    <div class="container">
      <!-- Scoreboard section for summary metrics -->
      <div class="scoreboard" id="scoreboard"></div>
      <!-- Grid of charts -->
      <div class="charts-grid">
        <div class="chart-container"><canvas id="priorityChart"></canvas></div>
        <div class="chart-container"><canvas id="domainCountChart"></canvas></div>
        <div class="chart-container"><canvas id="colleagueEndpointChart"></canvas></div>
        <div class="chart-container"><canvas id="loginBarChart"></canvas></div>
        <div class="chart-container"><canvas id="statusCodeChart"></canvas></div>
        <div class="chart-container"><canvas id="portChart"></canvas></div>
        <div class="chart-container"><canvas id="serviceChart"></canvas></div>
        <div class="chart-container"><canvas id="techChart"></canvas></div>
        <div class="chart-container"><canvas id="tlsUsageChart"></canvas></div>
        <div class="chart-container"><canvas id="certExpiryChart"></canvas></div>
        <div class="chart-container"><canvas id="headersChart"></canvas></div>
        <div class="chart-container"><canvas id="emailSecChart"></canvas></div>
        <div class="chart-container"><canvas id="cdnStackedChart"></canvas></div>
        <div class="chart-container"><canvas id="nsChart"></canvas></div>
      </div>
      <!-- Controls above the table: search box and rows per page selector -->
      <div class="table-top-controls">
        <input type="text" id="searchBox" placeholder="Filter table (e.g. domain, status code, tech)..." />
        <div class="hint">
          <h4>Mouseover to Risk Score to Evaluate Reasons for Scoring</h4>
        </div>
        <div class="table-controls">
          <label for="rowsPerPageSelect">Rows per page:</label>
          <select id="rowsPerPageSelect">
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">ALL</option>
          </select>
        </div>
      </div>
      <!-- Main report table with dynamic filters in header -->
      <div class="table-container">
        <table id="report-table">
          <thead>
            <tr>
              <th id="riskScoreHeader">Attack Surface Score<span id="riskSortToggle" style="cursor:pointer; user-select:none; margin-left:5px;">▼</span></th>
              <th>Domain</th>
              <th>Purpose</th>
              <th>Resolvers</th>
              <th>A Records</th>
              <th>NS Records</th>
              <th>MX Records</th>
              <th>PTR Records</th>
              <th>DNS Status</th>
              <th>CDN Name</th>
              <th>CDN Type</th>
              <th>Port</th>
              <th>URL</th>
              <th>Screenshot</th>
              <th>Redirect Location</th>
              <th>Homepage Title</th>
              <th>Web Server</th>
              <th>Login Found</th>
              <th>API Endpoint</th>
              <th>Technology Stack</th>
              <th>Status Code</th>
              <th>Content Length</th>
              <th>CDN</th>
              <th>SPF Record</th>
              <th>DKIM Record</th>
              <th>DMARC Record</th>
              <th>DNSSEC Record</th>
              <th>SSL/TLS Version</th>
              <th>Cert Expiry Date</th>
              <th>SSL/TLS Issuer</th>
              <th>Strict-Transport-Security</th>
              <th>X-Frame-Options</th>
              <th>Content-Security-Policy</th>
              <th>X-XSS-Protection</th>
              <th>Referrer Policy</th>
              <th>Permissions Policy</th>
              <th>Open Ports / Services</th>
              <th>Crawled Links</th>
            </tr>
            <!-- Second header row for filter dropdowns per column -->
            <tr id="filter-row">
              <th><select id="priority-filter"><option value="">All</option></select></th>
              <th><select id="domain-filter"><option value="">All</option></select></th>
              <th><select id="purpose-filter"><option value="">All</option></select></th>
              <th><select id="resolvers-filter"><option value="">All</option></select></th>
              <th><select id="arecords-filter"><option value="">All</option></select></th>
              <th><select id="ns-filter"><option value="">All</option></select></th>
              <th><select id="mx-filter"><option value="">All</option></select></th>
              <th><select id="ptr-filter"><option value="">All</option></select></th>
              <th><select id="dnsstatus-filter"><option value="">All</option></select></th>
              <th><select id="cdnname-filter"><option value="">All</option></select></th>
              <th><select id="cdntype-filter"><option value="">All</option></select></th>
              <th><select id="port-filter"><option value="">All</option></select></th>
              <th><select id="url-filter"><option value="">All</option></select></th>
              <th>
                <select id="screenshot-filter">
                  <option value="">All</option>
                  <option value="has screenshot">Has screenshot</option>
                  <option value="no screenshot">No screenshot</option>
                </select>
              </th>
              <th><select id="redirect-filter"><option value="">All</option></select></th>
              <th><select id="title-filter"><option value="">All</option></select></th>
              <th><select id="webserver-filter"><option value="">All</option></select></th>
              <th><select id="login-filter"><option value="">All</option></select></th>
              <th><select id="api-endpoint-filter"><option value="">All</option></select></th>
              <th><select id="tech-filter"><option value="">All</option></select></th>
              <th><select id="statuscode-filter"><option value="">All</option></select></th>
              <th><select id="contentlength-filter"><option value="">All</option></select></th>
              <th><select id="cdn-filter"><option value="">All</option></select></th>
              <th><select id="spf-filter"><option value="">All</option></select></th>
              <th><select id="dkim-filter"><option value="">All</option></select></th>
              <th><select id="dmarc-filter"><option value="">All</option></select></th>
              <th><select id="dnssec-filter"><option value="">All</option></select></th>
              <th><select id="sslversion-filter"><option value="">All</option></select></th>
              <th><select id="certexpiry-filter"><option value="">All</option></select></th>
              <th><select id="sslissuer-filter"><option value="">All</option></select></th>
              <th><select id="sts-filter"><option value="">All</option></select></th>
              <th><select id="xfo-filter"><option value="">All</option></select></th>
              <th><select id="csp-filter"><option value="">All</option></select></th>
              <th><select id="xss-filter"><option value="">All</option></select></th>
              <th><select id="rp-filter"><option value="">All</option></select></th>
              <th><select id="pp-filter"><option value="">All</option></select></th>
              <th><select id="ports-services-filter"><option value="">All</option></select></th>
              <th><select id="crawledlinks-filter"><option value="">All</option></select></th>
            </tr>
          </thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </div>
      <!-- Container for pagination controls -->
      <div id="paginationControls"></div>
    </div>
    <!-- Modal HTML -->
    <div id="screenshotModal">
      <div id="screenshotModalContent">
        <button id="closeModalBtn" onclick="closeModal()">Close</button>
        <img id="screenshotModalImg" src="" alt="Full Screenshot" />
      </div>
    </div>
    <script>
      // Plugin for displaying labels on bars in charts
      const barLabelPlugin = {
        id: 'barLabelPlugin',
        afterDatasetsDraw(chart, args, options) {
          const { ctx } = chart;
          const metaSets = chart.getSortedVisibleDatasetMetas().filter(m => m.type === 'bar');
          metaSets.forEach(meta => {
            meta.data.forEach((element, index) => {
              const value = meta._parsed[index][meta.vScale.axis];
              if (value === 0) return;
              const { x, y } = element.tooltipPosition();
              ctx.save();
              ctx.fillStyle = Chart.defaults.color;
              ctx.font = options.font || '9px sans-serif';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText(value, x, y - 2);
              ctx.restore();
            });
          });
        }
      };
      Chart.register(barLabelPlugin);

      // Global variables for charts and table data.
      let priorityChart, domainCountChart, statusCodeChart, loginChart, portChart, techChart, certExpiryChart, tlsUsageChart, headersChart, emailSecChart, cdnChart, serviceChart, colleagueChart, cdnTypeChart, cdnStackedChart;
      let allTableRows = [];
      let currentPage = 1;
      let rowsPerPage = 20;
      let riskScores = {};
      let minRiskScore = Infinity;
      let maxRiskScore = -Infinity;
      let riskSortOrder = "desc";

      // CSV Export Functions
      function downloadCSV(csv, filename) {
        const csvFile = new Blob([csv], { type: "text/csv" });
        const downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }
      function exportAllTableRowsToCSV(filename) {
        const csv = [];
        const headerRow = document.querySelectorAll("#report-table thead tr")[0];
        const headers = [];
        headerRow.querySelectorAll("th").forEach(th => {
          headers.push('"' + th.innerText.trim().replace(/"/g, '""') + '"');
        });
        csv.push(headers.join(","));
        allTableRows.forEach(row => {
          const cols = row.querySelectorAll("td");
          const rowData = [];
          cols.forEach(td => {
            rowData.push('"' + td.innerText.trim().replace(/"/g, '""') + '"');
          });
          csv.push(rowData.join(","));
        });
        downloadCSV(csv.join("\n"), filename);
      }
      document.getElementById("exportCsvButton").addEventListener("click", function() {
        exportAllTableRowsToCSV("report.csv");
      });

      // Theme toggle
      document.getElementById("themeToggle").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        updateChartTheme();
      });
      function updateChartTheme() {
        const newColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
        Chart.defaults.color = newColor;
        const charts = [
          priorityChart, domainCountChart, statusCodeChart, loginChart,
          portChart, techChart, certExpiryChart, tlsUsageChart,
          headersChart, emailSecChart, cdnChart, serviceChart, colleagueChart, cdnTypeChart, cdnStackedChart
        ];
        charts.forEach(chart => {
          if (chart) {
            if (chart.options.scales) {
              if (chart.options.scales.x && chart.options.scales.x.ticks) {
                chart.options.scales.x.ticks.color = newColor;
              }
              if (chart.options.scales.y && chart.options.scales.y.ticks) {
                chart.options.scales.y.ticks.color = newColor;
              }
            }
            if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
              chart.options.plugins.legend.labels.color = newColor;
            }
            if (chart.options.plugins && chart.options.plugins.title) {
              chart.options.plugins.title.color = newColor;
            }
            chart.update();
          }
        });
      }

      // Utility function
      function formatCell(arr) {
        return (arr && arr.length) ? arr.join("<br>") : "N/A";
      }

      // Compute risk score
      function computePriority({
        purpose, url, loginFound, statusCode, sslVersion, certExpiry,
        sts, xfo, csp, xss, rp, pp, openPortsCount, dbPortsCount, managementPortsCount, techCount, linkCount
      }) {

        let score = 0;
        const reasons = [];
        if (purpose && purpose.toLowerCase().includes("employee")) {
          score += 1;
          reasons.push("+1 (Potential employee-intended domain found)");
        }
        if (url && url !== "N/A") {
          score += 1;
          reasons.push("+1 (Domain has live application)");
        }
        if (loginFound === "Yes") {
          score += 1;
          reasons.push("+1 (Login interface found on application)");
        }
        if (statusCode === 200) {
          score += 1;
          reasons.push("+1 (Application has 200 status code)");
        }
        if (sslVersion) {
          const cleanVersion = sslVersion.replace(/\s+/g, '');
          if (/^TLSv(1\.2|1\.3)$/i.test(cleanVersion)) {
            reasons.push("+0 (Version of TLS is latest)");
          } else if (/^TLSv(1\.0|1\.1)$/i.test(cleanVersion)) {
            score += 2;
            reasons.push("+1 (TLSv1.0 or TLSv1.1)");
          } else if (/^SSLv(1\.0|2\.0|3\.0)$/i.test(cleanVersion)) {
            score += 5;
            reasons.push("+5 (SSLv1/2/3)");
          }
        } else {
          score += 1;
          reasons.push("+1 (no sslVersion reported)");
        }
        if (certExpiry && certExpiry !== "N/A") {
          const expiryDate = new Date(certExpiry);
          const now = new Date();
          const diffDays = (expiryDate - now) / (1000 * 60 * 60 * 24);
          if (!isNaN(diffDays)) {
            if (diffDays < 0) {
              score += 20;
              reasons.push("+20 (certificate expired)");
            } else if (diffDays <= 7) {
              score += 10;
              reasons.push("+10 (cert expires in ≤7 days)");
            } else if (diffDays <= 14) {
              score += 5;
              reasons.push("+5 (cert expires in ≤14 days)");
            } else if (diffDays <= 30) {
              score += 2;
              reasons.push("+2 (cert expires in ≤30 days)");
            }
          }
        }
        function missingHeader(val) {
          return !val || val.trim() === "" || val.trim().toLowerCase() === "false";
        }
        if (missingHeader(sts)) { score += 1; reasons.push("+1 (Missing HSTS)"); }
        if (missingHeader(xfo)) { score += 1; reasons.push("+1 (Missing X-Frame-Options)"); }
        if (missingHeader(csp)) { score += 1; reasons.push("+1 (missing CSP)"); }
        if (missingHeader(xss)) { score += 1; reasons.push("+1 (Missing X-XSS-Protection)"); }
        if (missingHeader(rp)) { score += 1; reasons.push("+1 (Missing Referrer-Policy)"); }
        if (missingHeader(pp)) { score += 1; reasons.push("+1 (Missing Permissions-Policy)"); }
        if (openPortsCount && Number.isFinite(openPortsCount)) {
          score += openPortsCount;
          reasons.push(`+${openPortsCount} (Each Open ports)`);
        }
        if (dbPortsCount && Number.isFinite(dbPortsCount)) {
          score += dbPortsCount;
          reasons.push(`+${dbPortsCount} (Database ports)`);
        }
        if (managementPortsCount && Number.isFinite(managementPortsCount)) {
          score += managementPortsCount;
          reasons.push(`+${managementPortsCount} (Management ports)`);
        }
        if (techCount && Number.isFinite(techCount)) {
          score += techCount;
          reasons.push(`+${techCount} (Tech stack count)`);
        }
          if (linkCount && Number.isFinite(linkCount) && linkCount > 0) {
            score += linkCount;
            reasons.push(`${linkCount} crawled links for this URL`);

        }
        return { score, debug: reasons };
      }

      function getDynamicColor(score, minScore, maxScore) {
        if (maxScore === minScore) return "rgb(46, 204, 113)";
        const fraction = (score - minScore) / (maxScore - minScore);
        const start = { r: 46, g: 204, b: 113 };
        const end   = { r: 231, g: 76, b: 60 };
        const r = Math.round(start.r + fraction * (end.r - start.r));
        const g = Math.round(start.g + fraction * (end.g - start.g));
        const b = Math.round(start.b + fraction * (end.b - start.b));
        return `rgb(${r}, ${g}, ${b})`;
      }

      function buildScoreboard({ totalSubdomains, liveSubs, totalHttpx, loginFoundCount }) {
        const sb = document.getElementById("scoreboard");
        sb.innerHTML = `
          <div class="score-card">
            <h2>${totalSubdomains}</h2>
            <p>Total Unique Assets</p>
          </div>
          <div class="score-card">
            <h2>${liveSubs}</h2>
            <p>Total Live Assets</p>
          </div>
          <div class="score-card">
            <h2>${totalHttpx}</h2>
            <p>Application Endpoints</p>
          </div>
          <div class="score-card">
            <h2>${loginFoundCount}</h2>
            <p>Login Interface Found</p>
          </div>
        `;
      }

      // The following functions build various charts...
      function buildCharts({ statusCount, priorityCount, portCount, techCount, totalSubdomains, liveSubs, endpointsCount }) {
        const scCanvas = document.getElementById("statusCodeChart");
        const prCanvas = document.getElementById("priorityChart");
        const portCanvas = document.getElementById("portChart");
        const techCanvas = document.getElementById("techChart");
        if (prCanvas) {
          const funnelLabels = ["Total Assets", "Live Assets", "Applications"];
          const funnelValues = [totalSubdomains, liveSubs, endpointsCount];
          if (priorityChart) priorityChart.destroy();
          priorityChart = new Chart(prCanvas, {
            type: "bar",
            data: {
              labels: funnelLabels,
              datasets: [{
                label: "Assets Overview",
                data: funnelValues,
                backgroundColor: ["#2980b9", "#8e44ad", "#16a085"]
              }]
            },
            options: {
              responsive: true,
              indexAxis: "x",
              plugins: { legend: { display: false }, title: { display: true, text: "Assets Overview" } },
              scales: { x: { beginAtZero: true, title: { display: true, text: "Count" } } }
            }
          });
        }
        if (scCanvas) {
          const sortedKeys = Object.keys(statusCount).sort((a, b) => +a - +b);
          statusCodeChart = new Chart(scCanvas, {
            type: "bar",
            data: {
              labels: sortedKeys,
              datasets: [{
                label: "HTTP Status Codes",
                data: sortedKeys.map(l => statusCount[l]),
                backgroundColor: ["#3498db","#1abc9c","#9b59b6","#f1c40f","#e74c3c","#34495e","#95a5a6"]
              }]
            },
            options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: "HTTP Status Codes" } }, scales: { y: { beginAtZero: true } } }
          });
        }
        if (portCanvas) {
          const sortedPorts = Object.keys(portCount).sort((a, b) => portCount[b] - portCount[a]);
          const top10Ports = sortedPorts.slice(0, 10);
          portChart = new Chart(portCanvas, {
            type: "bar",
            data: {
              labels: top10Ports,
              datasets: [{
                label: "Open Ports",
                data: top10Ports.map(p => portCount[p]),
                backgroundColor: "#f39c12"
              }]
            },
            options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: "Top 10 Ports" } }, scales: { y: { beginAtZero: true } } }
          });
        }
        if (techCanvas) {
          const sortedTech = Object.keys(techCount).sort((a, b) => techCount[b] - techCount[a]);
          const top10 = sortedTech.slice(0, 10);
          techChart = new Chart(techCanvas, {
            type: "bar",
            data: {
              labels: top10,
              datasets: [{
                label: "Tech Usage (Top 10)",
                data: top10.map(t => techCount[t]),
                backgroundColor: "#9b59b6"
              }]
            },
            options: {
              responsive: true,
              indexAxis: "x",
              plugins: { legend: { display: false }, title: { display: true, text: "Top 10 Technologies" } },
              scales: { x: { beginAtZero: true, ticks: { maxRotation: 60, minRotation: 70 } } }
            }
          });
        }
      }

      function buildCDNStackedChart(httpxData) {
        const cdnMap = {};
        httpxData.forEach(record => {
          let cdnName = record.cdn_name && record.cdn_name.trim();
          let cdnType = record.cdn_type && record.cdn_type.trim();
          if (!cdnName || cdnName === "N/A") return;
          if (!cdnType || cdnType === "N/A") cdnType = "Unknown";
          if (!cdnMap[cdnName]) cdnMap[cdnName] = {};
          cdnMap[cdnName][cdnType] = (cdnMap[cdnName][cdnType] || 0) + 1;
        });
        const cdnNames = Object.keys(cdnMap);
        const cdnTypesSet = new Set();
        cdnNames.forEach(name => { Object.keys(cdnMap[name]).forEach(type => cdnTypesSet.add(type)); });
        const cdnTypes = Array.from(cdnTypesSet);
        const palette = ["#3498db","#1abc9c","#9b59b6","#f1c40f","#e74c3c","#34495e","#95a5a6","#e67e22","#2ecc71","#8e44ad","#7f8c8d"];
        const datasets = cdnTypes.map((type, idx) => ({
          label: type,
          data: cdnNames.map(name => cdnMap[name][type] || 0),
          backgroundColor: palette[idx % palette.length]
        }));
        const ctx = document.getElementById("cdnStackedChart").getContext("2d");
        cdnStackedChart = new Chart(ctx, {
          type: "bar",
          data: { labels: cdnNames, datasets: datasets },
          options: {
            responsive: true,
            plugins: { title: { display: true, text: "CDN Type vs. CDN Name" }, tooltip: { mode: "index", intersect: false } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
          }
        });
      }

      function buildDomainCountChart(httpxData) {
        const domainCount = {};
        httpxData.forEach(h => {
          if (h.url && h.url !== "N/A") {
            const domain = (h.input || "").split(":")[0];
            domainCount[domain] = (domainCount[domain] || 0) + 1;
          }
        });
        const sortedDomains = Object.keys(domainCount).sort((a, b) => domainCount[b] - domainCount[a]);
        const top10 = sortedDomains.slice(0, 10);
        const data = top10.map(d => domainCount[d]);
        const ctx = document.getElementById("domainCountChart").getContext("2d");
        domainCountChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: top10,
            datasets: [{ label: "Top 10 Domains (Active URLs)", data, backgroundColor: "#2980b9" }]
          },
          options: {
            responsive: true,
            indexAxis: "x",
            plugins: { legend: { display: false }, title: { display: true, text: "Top 10 Domains by Active URLs" } },
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1, maxRotation: 100, minRotation: 70 } } }
          }
        });
      }

      function buildLoginBarChart(endpointsCount, loginFoundCount) {
        const canvas = document.getElementById("loginBarChart");
        if (!canvas) return;
        loginChart = new Chart(canvas, {
          type: "bar",
          data: {
            labels: ["Found", "Not Found"],
            datasets: [{ data: [loginFoundCount, endpointsCount - loginFoundCount], backgroundColor: ["#e74c3c", "#2ecc71"] }]
          },
          options: { responsive: true, plugins: { title: { display: true, text: "Login Interfaces Identified" }, legend: { display: false } } }
        });
      }

      function buildCertExpiryChart(secData) {
        let now = new Date(), expired = 0, exp7 = 0, exp14 = 0, exp30 = 0;
        secData.forEach(item => {
          const expiryStr = item["Cert Expiry Date"];
          if (expiryStr && expiryStr !== "N/A") {
            let expiryDate = new Date(expiryStr);
            if (!isNaN(expiryDate)) {
              let diffDays = (expiryDate - now) / (1000 * 60 * 60 * 24);
              if (diffDays < 0) expired++;
              else if (diffDays <= 7) exp7++;
              else if (diffDays <= 14) exp14++;
              else if (diffDays <= 30) exp30++;
            }
          }
        });
        const ctx = document.getElementById("certExpiryChart").getContext("2d");
        certExpiryChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Expired", "Next 7 Days", "Next 14 Days", "Next 30 Days"],
            datasets: [{ label: "Certs Expiring", data: [expired, exp7, exp14, exp30], backgroundColor: ["#FF0000", "#e74c3c", "#e67e22", "#3498db"] }]
          },
          options: { responsive: true, plugins: { title: { display: true, text: "Certificate Expiry" }, legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      function buildTLSUsageChart(secData) {
        const tlsCounts = {};
        secData.forEach(item => {
          let ver = item["SSL/TLS Version"];
          ver = ver ? ver.trim() : "Unknown";
          tlsCounts[ver] = (tlsCounts[ver] || 0) + 1;
        });
        const labels = Object.keys(tlsCounts);
        const data = labels.map(l => tlsCounts[l]);
        const ctx = document.getElementById("tlsUsageChart").getContext("2d");
        tlsUsageChart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets: [{ label: "TLS Version Usage", data, backgroundColor: "#2ecc71" }] },
          options: { responsive: true, plugins: { title: { display: true, text: "SSL/TLS Usage" }, legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      function buildHeadersChart(httpxData, secMapUrlParam) {
        let hstsPresent = 0, hstsMissing = 0, xfoPresent = 0, xfoMissing = 0,
            cspPresent = 0, cspMissing = 0, xssPresent = 0, xssMissing = 0,
            rpPresent = 0, rpMissing = 0, ppPresent = 0, ppMissing = 0;
        httpxData.forEach(record => {
          const sec = secMapUrlParam[record.url] || {};
          const hsts = (sec["Strict-Transport-Security"] || "").trim();
          hsts && hsts.toLowerCase() !== "n/a" && hsts.toLowerCase() !== "false" ? hstsPresent++ : hstsMissing++;
          const xfo = (sec["X-Frame-Options"] || "").trim();
          xfo && xfo.toLowerCase() !== "n/a" && xfo.toLowerCase() !== "false" ? xfoPresent++ : xfoMissing++;
          const csp = (sec["Content-Security-Policy"] || "").trim();
          csp && csp.toLowerCase() !== "n/a" && csp.toLowerCase() !== "false" ? cspPresent++ : cspMissing++;
          const xss = (sec["X-XSS-Protection"] || "").trim();
          xss && xss.toLowerCase() !== "n/a" && xss.toLowerCase() !== "false" ? xssPresent++ : xssMissing++;
          const rp = (sec["Referrer-Policy"] || "").trim();
          rp && rp.toLowerCase() !== "n/a" && rp.toLowerCase() !== "false" ? rpPresent++ : rpMissing++;
          const pp = (sec["Permissions-Policy"] || "").trim();
          pp && pp.toLowerCase() !== "n/a" && pp.toLowerCase() !== "false" ? ppPresent++ : ppMissing++;
        });
        const ctx = document.getElementById("headersChart").getContext("2d");
        headersChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["HSTS", "X-Frame-Options", "CSP", "X-XSS-Protection", "Referrer-Policy", "Permissions-Policy"],
            datasets: [
              { label: "Present", data: [hstsPresent, xfoPresent, cspPresent, xssPresent, rpPresent, ppPresent], backgroundColor: "#2ecc71" },
              { label: "Missing", data: [hstsMissing, xfoMissing, cspMissing, xssMissing, rpMissing, ppMissing], backgroundColor: "#e74c3c" }
            ]
          },
          options: {
            responsive: true,
            indexAxis: "x",
            plugins: { title: { display: true, text: "Security Headers" }, tooltip: { mode: "index", intersect: false } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
          }
        });
      }

      function buildEmailSecChart(secData) {
        let spfSet = 0, spfMissing = 0, dkimSet = 0, dkimMissing = 0, dmarcSet = 0, dmarcMissing = 0;
        secData.forEach(item => {
          const spf = item["SPF Record"] || "";
          const dkim = item["DKIM Record"] || "";
          const dmarc = item["DMARC Record"] || "";
          spf.toLowerCase().includes("spf1") ? spfSet++ : spfMissing++;
          dkim.toLowerCase().includes("dkim1") ? dkimSet++ : dkimMissing++;
          dmarc.toLowerCase().includes("dmarc1") ? dmarcSet++ : dmarcMissing++;
        });
        const ctx = document.getElementById("emailSecChart").getContext("2d");
        emailSecChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["SPF", "DKIM", "DMARC"],
            datasets: [
              { label: "Present", data: [spfSet, dkimSet, dmarcSet], backgroundColor: "#2ecc71" },
              { label: "Missing", data: [spfMissing, dkimMissing, dmarcMissing], backgroundColor: "#e74c3c" }
            ]
          },
          options: {
            responsive: true,
            plugins: { title: { display: true, text: "Email Security Records" }, tooltip: { mode: "index", intersect: false } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
          }
        });
      }

      function buildServiceChart(naabuData) {
        const naabuMap = {};
        const serviceCount = {};
        naabuData.forEach(n => {
          const domain = n.host;
          const port = n.port;
          let service = "Unknown";
          const portServiceDB = {"7":"Echo","9":"Discard","13":"Daytime","21":"FTP","22":"SSH","23":"Telnet","25":"Simple Mail Transfer","26":"Unassigned","37":"Time","53":"Domain Name Server","66":"Oracle SQL*NET","79":"Finger","80":"HTTP","81":"Unassigned","88":"Kerberos","92":"Network Printing Protocol","99":"Metagram Relay","106":"3COM-TSMUX","110":"Post Office Protocol - Version 3","111":"SUN Remote Procedure Call","113":"Authentication Service","119":"Network News Transfer Protocol","135":"DCE endpoint resolution","139":"NETBIOS Session Service","143":"Reserved","144":"Universal Management Architecture","179":"BGP","199":"SMUX","443":"HTTPS","444":"Simple Network Paging Protocol","445":"Microsoft-DS","457":"scohelp","465":"IGMP over UDP for SSM","513":"maintains data bases showing who's logged in to machines on a local net and the load average of the machine","514":"rsh","515":"spooler","543":"Klogin","544":"krcmd","548":"AFP over TCP","554":"Real Time Streaming Protocol (RTSP)","587":"Message Submission","631":"Internet Printing Protocol over HTTPS","646":"LDP","6646":"IRC","873":"rsync","8880":"CDDBP","8888":"NewsEDGE server UDP (UDP 1)","990":"ftp protocol, control, over TLS/SSL","992":"telnet protocol over TLS/SSL","993":"Reserved","995":"pop3 protocol over TLS/SSL (was spop3)","1024":"Reserved","1025":"network blackjack","1026":"Calendar Access Protocol","1027":"Reserved","1028":"Deprecated","1029":"Solid Mux Server","1080":"Socks","1100":"MCTP","1110":"Client status info","1194":"OpenVPN","1241":"nessus","1352":"Lotus Note","1433":"Microsoft-SQL-Server","1434":"Microsoft-SQL-Monitor","1521":"nCube License Manager","1522":"Ricardo North America License Manager","15672":"RabbitMQ Mgmt","1720":"H.323 Call Control","1723":"pptp","1755":"ms-streaming","1900":"SSDP","1944":"close-combat","2000":"Cisco SCCp","2001":"curry","2049":"Network File System","2121":"SCIENTIA-SSDB","2222":"EtherNet/IP I/O","2301":"Compaq HTTP","2323":"3d-nfsd","2483":"Oracle TTC","2484":"Oracle TTC SSL","2638":"Sybase Anywhere","27017":"Reserved","27018":"MongoDB","27019":"MongoDB","2717":"PN REQUESTER","28015":"RethinkDB","3000":"RemoteWare Client","3050":"gds_db","3128":"Active API Server Port","32768":"Filenet TMS","3306":"MySQL","3389":"MS WBT Server","3986":"MAPPER workstation server","4000":"Terabase","4001":"NewOak","4002":"pxc-spvr-ft","4100":"IGo Incognito Data Port","4567":"TRAM","4899":"RAdmin Port","49152":"N/A","49153":"N/A","49154":"N/A","49155":"N/A","49156":"N/A","49157":"N/A","5000":"UPnP","5001":"N/A","5009":"Microsoft Windows Filesystem","5051":"ITA Agent","5060":"SIP","5101":"Talarian_UDP","5190":"America-Online","5357":"Web Services for Devices","5432":"PostgreSQL Database","5631":"pcANYWHEREdata","5666":"Reserved","5800":"VNC","5801":"VNC","5802":"VNC","5803":"VNC","5804":"VNC","5805":"VNC","5806":"VNC","5807":"VNC","5809":"VNC","5900":"Remote Framebuffer","5984":"CouchDB","5985":"WBEM WS-Management HTTP","5986":"WBEM WS-Management HTTP over TLS/SSL","6000":"X11","6001":"X11","6346":"gnutella-svc","6347":"gnutella-rtr","6379":"Reserved","6513":"Reserved","7000":"file server itself","7001":"callbacks to cache managers","7002":"users & groups database","7070":"ARCP","7170":"Adaptive Name/Service Resolution","7199":"Cassandra","7474":"Reserved","7647":"N/A","7687":"Reserved","7777":"cbt","8000":"iRDMI","8001":"VCOM Tunnel","8008":"HTTP Alternate","8009":"Reserved","8080":"HTTP Alternate (see port 80)","8081":"Sun Proxy Admin Service","8083":"Utilistor (Server)","8085":"Unassigned","8089":"Unassigned","8090":"Reserved","8181":"Reserved","8291":"MikroTik","8443":"PCsync HTTPS","9000":"CSlistener","9080":"Groove GLRPC","9090":"WebSM","9091":"xmltec-xmlmail","9092":"Xml-Ipc Server Reg","9100":"Printer PDL Data Stream","9200":"WAP connectionless session service","9443":"WSO2 Tungsten HTTPS","9990":"OSM Applet Server","9999":"distinct","10000":"Network Data Management Protocol","10080":"Amanda","10443":"Reserved","11211":"Memory cache service","20000":"Distributed Network Protocol","54321":"N/A","30821":"N/A","9042":"Cassandra CQL","9160":"apani1"};
          if (portServiceDB[port]) service = portServiceDB[port];
          if (!naabuMap[domain]) naabuMap[domain] = [];
          naabuMap[domain].push({ port, service });
          serviceCount[service] = (serviceCount[service] || 0) + 1;
        });
        window.naabuMap = naabuMap;
        const ctx = document.getElementById("serviceChart").getContext("2d");
        const sortedServices = Object.keys(serviceCount).sort((a, b) => serviceCount[b] - serviceCount[a]);
        const top10Services = sortedServices.slice(0, 10);
        const data = top10Services.map(service => serviceCount[service]);
        serviceChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: top10Services,
            datasets: [{
              label: "Open Services",
              data,
              backgroundColor: "#9b59b6"
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: "Top 10 Services" } },
          scales: { x: { beginAtZero: true, ticks: { maxRotation: 60, minRotation: 70 } } } }
        });
      }

      function buildColleagueChart(colleagueData) {
        const countEmployee = colleagueData.filter(x => x.colleague_endpoint === "Yes").length;
        const countCustomer = colleagueData.length - countEmployee;
        const ctx = document.getElementById("colleagueEndpointChart").getContext("2d");
        colleagueChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Employee Intended", "Customer Intended"],
            datasets: [{
              label: "Purpose Count",
              data: [countEmployee, countCustomer],
              backgroundColor: ["#e74c3c", "#2ecc71"]
            }]
          },
          options: { responsive: true, plugins: { title: { display: true, text: "Employee vs Customer Intended Endpoints" }, legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      function buildNSChart(labels, data) {
        const trimmedLabels = labels.map(label => {
          const parts = label.split(".").filter(part => part.trim().length > 0);
          return parts.length > 3 ? parts.slice(-3).join(".") : label;
        });
        const top5Labels = trimmedLabels.slice(0, 5);
        const top5Data = data.slice(0, 5);
        const bgColors = ["#3498db", "#1abc9c", "#9b59b6", "#f1c40f", "#e74c3c"];
        const ctx = document.getElementById("nsChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: top5Labels,
            datasets: [{
              label: "Nameserver Summary",
              data: top5Data,
              backgroundColor: bgColors
            }]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            plugins: { title: { display: true, text: "Top 5 Name Servers (Hosting Providers)" }, tooltip: { enabled: true }, legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
      }

      // Global array to store table rows.
      let rowDataStore = [];

      // Build table rows
      function buildTableRows(combinedData, secMapDomain, secMapUrl, loginMap, apiMap, colleagueMap) {
        allTableRows = [];
        rowDataStore = [];
        Object.keys(combinedData).forEach(domain => {
          const { dns, http } = combinedData[domain];
          const dnsResolvers = dns && dns.resolver ? dns.resolver : [];
          const dnsA = dns && dns.a ? dns.a : [];
          const dnsStatus = dns ? dns.status_code : "N/A";
          const domainSec = secMapDomain[domain] || {};
          const spf = domainSec["SPF Record"] || "N/A";
          const dkim = domainSec["DKIM Record"] || "N/A";
          const dmarc = domainSec["DMARC Record"] || "N/A";
          const dnssec = domainSec["DNSSEC Status"] || "N/A";
          const nsRecords = (domainSec["NS Records"] || "N/A").replace(/\n/g, " ");
          const mxRecords = (domainSec["MX Records"] || "N/A").replace(/\n/g, " ");
          const ptrRecords = domainSec["PTR Record"] || "N/A";
          if (http && http.length) {
            http.forEach(h => {
              // Compute port and screenshot key for this record
              const port = h.port ? h.port : (h.url && h.url.startsWith("https") ? 443 : 80);
              const screenshotKey = domain + "_" + port;
              let screenshotHTML = "No screenshot";
              // Use the global screenshotMap defined earlier

              if (screenshotMap[screenshotKey]) {
                screenshotHTML = `
                  <span style="display:none;">has screenshot</span>
                  <img
                    src="${screenshotMap[screenshotKey]}"
                    class="thumbnail"
                    onclick="openModal('${screenshotMap[screenshotKey]}')"
                    alt="screenshot"
                  />
                `;
              } else {
                screenshotHTML = `
                  <span style="display:none;">no screenshot</span>
                  No screenshot
                `;
              }

              const urlSec = secMapUrl[h.url] || domainSec;
              const sslVersion = urlSec["SSL/TLS Version"] || "N/A";
              const certExpiry = urlSec["Cert Expiry Date"] || "N/A";
              const sslIssuer = urlSec["SSL/TLS Issuer"] || "N/A";
              const stsFlag = (urlSec["Strict-Transport-Security"] || "").trim();
              const xfoFlag = (urlSec["X-Frame-Options"] || "").trim();
              const cspFlag = (urlSec["Content-Security-Policy"] || "").trim();
              const xssFlag = (urlSec["X-XSS-Protection"] || "").trim();
              const rpFlag = (urlSec["Referrer-Policy"] || "").trim();
              const ppFlag = (urlSec["Permissions-Policy"] || "").trim();
              const techArr = Array.isArray(h.tech) ? h.tech : [];
              const sanitizedTech = techArr.map(item => item.replace(/\r?\n|\r/g, " ").trim());
              const techCount = sanitizedTech.length;
              const openPorts = (window.naabuMap && window.naabuMap[domain]) || [];
              const openPortsCount = openPorts.length;
              // Initialize counts for all three port categories
              let dbPortsCount = 0;
              let managementPortsCount = 0;

              openPorts.forEach(portObj => {
                const port = Number(portObj.port);

                // Database Ports (Expanded)
                if ([1433, 1434, 1521, 1522, 2483, 2484, 2638, 3050, 3306, 3389, 5432, 5984, 6379, 7000, 7199, 7474, 7687, 9042, 9160, 27017, 27018, 27019, 28015].includes(port)) {
                  dbPortsCount++;
                }

                // Management Ports (Expanded)
                if ([8000, 8008, 8080, 8081, 8083, 8089, 8090, 8443, 8880, 8888, 9000, 9090, 9091, 9092, 9100, 9990, 10000, 10080, 10443, 11211, 15672, 3000, 5000, 54321, 7001, 7002, 7070, 8181, 8800, 9200, 9443, 22, 23, 2222, 2323, 3389, 5900, 5800, 4899, 5631, 5666, 5985, 5986, 8291, 1723, 1194, 992, 6513, 5801, 5802, 5803, 5804, 5805, 5806, 5807, 5809].includes(port)) {
                  managementPortsCount++;
                }

              });

              const linksForUrl = (window.linksMap && window.linksMap[h.url]) ? window.linksMap[h.url] : [];
              const linkCount = linksForUrl.length;
              const linksCellHTML = linkCount > 0
                ? `<a href="#" onclick="openLinksModal('${h.url}'); return false;">${linkCount}</a>`
                : "N/A";

              const { score, debug } = computePriority({
                purpose: colleagueMap[domain] === "Yes" ? "Employee Intended" : "Customer Intended",
                url: h.url,
                loginFound: loginMap[h.url] || "N/A",
                statusCode: h.status_code,
                sslVersion,
                certExpiry,
                sts: stsFlag,
                xfo: xfoFlag,
                csp: cspFlag,
                xss: xssFlag,
                rp: rpFlag,
                pp: ppFlag,
                openPortsCount: window.naabuMap && window.naabuMap[domain] ? window.naabuMap[domain].length : 0,
                openPortsCount: openPortsCount,
                dbPortsCount: dbPortsCount,
                managementPortsCount: managementPortsCount,
                techCount,
                linkCount
              });
              if (score < minRiskScore) minRiskScore = score;
              if (score > maxRiskScore) maxRiskScore = score;
              riskScores[domain] = score;
              rowDataStore.push({ domain, prioScore: score });
              const row = document.createElement("tr");
              row.innerHTML = `
                <td><!-- risk score cell --></td>
                <td>${domain}</td>
                <td>${colleagueMap[domain] === "Yes" ? "Employee Intended" : "Customer Intended"}</td>
                <td>${formatCell(dnsResolvers)}</td>
                <td>${formatCell(dnsA)}</td>
                <td>${nsRecords}</td>
                <td>${mxRecords}</td>
                <td>${ptrRecords}</td>
                <td>${dnsStatus}</td>
                <td>${h.cdn_name || "N/A"}</td>
                <td>${h.cdn_type || "N/A"}</td>
                <td>${h.port || "N/A"}</td>
                <td>${h.url || "N/A"}</td>
                <td>${screenshotHTML}</td>
                <td>${h.location || "N/A"}</td>
                <td>${h.title || "N/A"}</td>
                <td>${h.webserver || "N/A"}</td>
                <td>${loginMap[h.url] || "N/A"}</td>
                <td>${apiMap[domain] || "No"}</td>
                <td>${sanitizedTech.length ? sanitizedTech.join("<br>") : "N/A"}</td>
                <td>${(h.status_code !== undefined) ? h.status_code : "N/A"}</td>
                <td>${(h.content_length !== undefined) ? h.content_length : "N/A"}</td>
                <td>${(h.cdn !== undefined) ? h.cdn : "N/A"}</td>
                <td>${spf}</td>
                <td>${dkim}</td>
                <td>${dmarc}</td>
                <td>${dnssec}</td>
                <td>${sslVersion}</td>
                <td>${certExpiry}</td>
                <td>${sslIssuer}</td>
                <td>${stsFlag ? "True" : "False"}</td>
                <td>${xfoFlag ? "True" : "False"}</td>
                <td>${cspFlag ? "True" : "False"}</td>
                <td>${xssFlag ? "True" : "False"}</td>
                <td>${rpFlag ? "True" : "False"}</td>
                <td>${ppFlag ? "True" : "False"}</td>
                <td>${
                  (window.naabuMap && window.naabuMap[domain])
                  ? window.naabuMap[domain].map(p => `${p.port} (${p.service})`).join("<br>")
                  : "N/A"
                }</td>
                <td>${linksCellHTML}</td>
              `;
              const scoreCell = row.getElementsByTagName("td")[0];
              scoreCell.innerText = score;
              scoreCell.title = debug.join("\n");
              allTableRows.push(row);
            });
          }
          else {
            // If no HTTP data for domain, create a default row.
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>N/A</td>
              <td>${domain}</td>
              <td>${colleagueMap[domain] === "Yes" ? "Employee Intended" : "Customer Intended"}</td>
              <td>${formatCell(dnsResolvers)}</td>
              <td>${formatCell(dnsA)}</td>
              <td>${nsRecords}</td>
              <td>${mxRecords}</td>
              <td>${ptrRecords}</td>
              <td>${dnsStatus}</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>No screenshot</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>${spf}</td>
              <td>${dkim}</td>
              <td>${dmarc}</td>
              <td>${dnssec}</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
            `;
            allTableRows.push(row);
          }
        });
      }

      function finalizeColors() {
        allTableRows.forEach(row => {
          const cells = row.getElementsByTagName("td");
          const scoreCell = cells[0];
          if (scoreCell.innerText === "N/A") return;
          const prioScore = parseInt(scoreCell.innerText, 10) || 0;
          const color = getDynamicColor(prioScore, minRiskScore, maxRiskScore);
          scoreCell.style.backgroundColor = color;
          scoreCell.style.color = "#fff";
        });
      }

      // Update filtering – note that we add a check for screenshot filter in column index 13.
      function getFilteredRows() {
        const query = document.getElementById("searchBox").value.toLowerCase();
        const filters = {
          priority: document.getElementById("priority-filter").value.toLowerCase(),
          domain: document.getElementById("domain-filter").value.toLowerCase(),
          purpose: document.getElementById("purpose-filter").value.toLowerCase(),
          resolvers: document.getElementById("resolvers-filter").value.toLowerCase(),
          arecords: document.getElementById("arecords-filter").value.toLowerCase(),
          ns: document.getElementById("ns-filter").value.toLowerCase(),
          mx: document.getElementById("mx-filter").value.toLowerCase(),
          ptr: document.getElementById("ptr-filter").value.toLowerCase(),
          dnsstatus: document.getElementById("dnsstatus-filter").value.toLowerCase(),
          cdnname: document.getElementById("cdnname-filter").value.toLowerCase(),
          cdntype: document.getElementById("cdntype-filter").value.toLowerCase(),
          port: document.getElementById("port-filter").value.toLowerCase(),
          url: document.getElementById("url-filter").value.toLowerCase(),
          screenshot: document.getElementById("screenshot-filter").value.toLowerCase(),
          location: document.getElementById("redirect-filter").value.toLowerCase(),
          title: document.getElementById("title-filter").value.toLowerCase(),
          webserver: document.getElementById("webserver-filter").value.toLowerCase(),
          login: document.getElementById("login-filter").value.toLowerCase(),
          apiEndpoint: document.getElementById("api-endpoint-filter").value.toLowerCase(),
          tech: document.getElementById("tech-filter").value.toLowerCase(),
          statuscode: document.getElementById("statuscode-filter").value.toLowerCase(),
          contentlength: document.getElementById("contentlength-filter").value.toLowerCase(),
          cdn: document.getElementById("cdn-filter").value.toLowerCase(),
          spf: document.getElementById("spf-filter").value.toLowerCase(),
          dkim: document.getElementById("dkim-filter").value.toLowerCase(),
          dmarc: document.getElementById("dmarc-filter").value.toLowerCase(),
          dnssec: document.getElementById("dnssec-filter").value.toLowerCase(),
          sslversion: document.getElementById("sslversion-filter").value.toLowerCase(),
          certexpiry: document.getElementById("certexpiry-filter").value.toLowerCase(),
          sslissuer: document.getElementById("sslissuer-filter").value.toLowerCase(),
          sts: document.getElementById("sts-filter").value.toLowerCase(),
          xfo: document.getElementById("xfo-filter").value.toLowerCase(),
          csp: document.getElementById("csp-filter").value.toLowerCase(),
          xss: document.getElementById("xss-filter").value.toLowerCase(),
          rp: document.getElementById("rp-filter").value.toLowerCase(),
          pp: document.getElementById("pp-filter").value.toLowerCase(),
          portsservices: document.getElementById("ports-services-filter").value.toLowerCase(),
          crawledlinks: document.getElementById("crawledlinks-filter").value.toLowerCase()

        };
        const filtered = allTableRows.filter(row => {
          const cells = row.getElementsByTagName("td");
          if (filters.priority && !cells[0].innerText.toLowerCase().includes(filters.priority)) return false;
          if (filters.domain && !cells[1].innerText.toLowerCase().includes(filters.domain)) return false;
          if (filters.purpose && !cells[2].innerText.toLowerCase().includes(filters.purpose)) return false;
          if (filters.resolvers && !cells[3].innerText.toLowerCase().includes(filters.resolvers)) return false;
          if (filters.arecords && !cells[4].innerText.toLowerCase().includes(filters.arecords)) return false;
          if (filters.ns && !cells[5].innerText.toLowerCase().includes(filters.ns)) return false;
          if (filters.mx && !cells[6].innerText.toLowerCase().includes(filters.mx)) return false;
          if (filters.ptr && !cells[7].innerText.toLowerCase().includes(filters.ptr)) return false;
          if (filters.dnsstatus && !cells[8].innerText.toLowerCase().includes(filters.dnsstatus)) return false;
          if (filters.cdnname && !cells[9].innerText.toLowerCase().includes(filters.cdnname)) return false;
          if (filters.cdntype && !cells[10].innerText.toLowerCase().includes(filters.cdntype)) return false;
          if (filters.port && !cells[11].innerText.toLowerCase().includes(filters.port)) return false;
          if (filters.url && !cells[12].innerText.toLowerCase().includes(filters.url)) return false;
          if (filters.screenshot && !cells[13].textContent.toLowerCase().includes(filters.screenshot)) {
            return false;
          }
          if (filters.location && !cells[14].innerText.toLowerCase().includes(filters.location)) return false;
          if (filters.title && !cells[15].innerText.toLowerCase().includes(filters.title)) return false;
          if (filters.webserver && !cells[16].innerText.toLowerCase().includes(filters.webserver)) return false;
          if (filters.login && !cells[17].innerText.toLowerCase().includes(filters.login)) return false;
          if (filters.apiEndpoint && !cells[18].innerText.toLowerCase().includes(filters.apiEndpoint)) return false;
          if (filters.tech && !cells[19].innerText.toLowerCase().includes(filters.tech)) return false;
          if (filters.statuscode && !cells[20].innerText.toLowerCase().includes(filters.statuscode)) return false;
          if (filters.contentlength && !cells[21].innerText.toLowerCase().includes(filters.contentlength)) return false;
          if (filters.cdn && !cells[22].innerText.toLowerCase().includes(filters.cdn)) return false;
          if (filters.spf && !cells[23].innerText.toLowerCase().includes(filters.spf)) return false;
          if (filters.dkim && !cells[24].innerText.toLowerCase().includes(filters.dkim)) return false;
          if (filters.dmarc && !cells[25].innerText.toLowerCase().includes(filters.dmarc)) return false;
          if (filters.dnssec && !cells[26].innerText.toLowerCase().includes(filters.dnssec)) return false;
          if (filters.sslversion && !cells[27].innerText.toLowerCase().includes(filters.sslversion)) return false;
          if (filters.certexpiry && !cells[28].innerText.toLowerCase().includes(filters.certexpiry)) return false;
          if (filters.sslissuer && !cells[29].innerText.toLowerCase().includes(filters.sslissuer)) return false;
          if (filters.sts && !cells[30].innerText.toLowerCase().includes(filters.sts)) return false;
          if (filters.xfo && !cells[31].innerText.toLowerCase().includes(filters.xfo)) return false;
          if (filters.csp && !cells[32].innerText.toLowerCase().includes(filters.csp)) return false;
          if (filters.xss && !cells[33].innerText.toLowerCase().includes(filters.xss)) return false;
          if (filters.rp && !cells[34].innerText.toLowerCase().includes(filters.rp)) return false;
          if (filters.pp && !cells[35].innerText.toLowerCase().includes(filters.pp)) return false;
          if (filters.portsservices && !cells[36].innerText.toLowerCase().includes(filters.portsservices)) return false;
          if (filters.crawledlinks && !cells[37].innerText.toLowerCase().includes(filters.crawledlinks)) return false;
          if (query && !row.innerText.toLowerCase().includes(query)) return false;
          return true;
        });
        filtered.sort((a, b) => {
          const scoreA = parseInt(a.cells[0].innerText) || 0;
          const scoreB = parseInt(b.cells[0].innerText) || 0;
          return riskSortOrder === "asc" ? scoreA - scoreB : scoreB - scoreA;
        });
        return filtered;
      }

      function renderTable(filteredRows) {
        const tBody = document.getElementById("report-table-body");
        tBody.innerHTML = "";
        let startIndex = 0;
        let endIndex = filteredRows.length;
        if (rowsPerPage !== "all" && rowsPerPage !== Infinity) {
          startIndex = (currentPage - 1) * rowsPerPage;
          endIndex = startIndex + rowsPerPage;
        }
        const rowsToShow = filteredRows.slice(startIndex, endIndex);
        rowsToShow.forEach(row => tBody.appendChild(row));
        renderPaginationControls(filteredRows.length);
      }

      function renderPaginationControls(totalRows) {
        const paginationDiv = document.getElementById("paginationControls");
        paginationDiv.innerHTML = "";
        if (rowsPerPage === "all" || rowsPerPage === Infinity) return;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const pageInfo = document.createElement("span");
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        paginationDiv.appendChild(pageInfo);
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Prev";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable(getFilteredRows());
          }
        });
        paginationDiv.appendChild(prevBtn);
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderTable(getFilteredRows());
          }
        });
        paginationDiv.appendChild(nextBtn);
      }

      function onFilterChange() {
        currentPage = 1;
        renderTable(getFilteredRows());
      }

      function updateRowsPerPage() {
        const select = document.getElementById("rowsPerPageSelect");
        const value = select.value;
        rowsPerPage = value === "all" ? Infinity : parseInt(value, 10);
        currentPage = 1;
        renderTable(getFilteredRows());
      }

      function populateColumnFilters() {
        const uniqueCols = Array.from({ length: 38 }, () => new Set());
        allTableRows.forEach(row => {
          const cells = row.getElementsByTagName("td");
          for (let col = 0; col < 38; col++) {
            if (cells[col]) uniqueCols[col].add(cells[col].innerText.trim());
          }
        });
        function fillSelectOptions(selectId, values) {
          const select = document.getElementById(selectId);
          const existing = select.querySelectorAll("option:not([value=''])");
          existing.forEach(opt => opt.remove());
          if (selectId === "priority-filter") {
            values = values.filter(v => !isNaN(v)).sort((a, b) => b - a);
          } else {
            values.sort();
          }
          values.forEach(val => {
            if (val.toLowerCase() === "asc" || val.toLowerCase() === "desc") return;
            const option = document.createElement("option");
            option.value = val;
            option.textContent = val;
            select.appendChild(option);
          });
        }
        fillSelectOptions("priority-filter", [...uniqueCols[0]]);
        fillSelectOptions("domain-filter", [...uniqueCols[1]]);
        fillSelectOptions("purpose-filter", [...uniqueCols[2]]);
        fillSelectOptions("resolvers-filter", [...uniqueCols[3]]);
        fillSelectOptions("arecords-filter", [...uniqueCols[4]]);
        fillSelectOptions("ns-filter", [...uniqueCols[5]]);
        fillSelectOptions("mx-filter", [...uniqueCols[6]]);
        fillSelectOptions("ptr-filter", [...uniqueCols[7]]);
        fillSelectOptions("dnsstatus-filter", [...uniqueCols[8]]);
        fillSelectOptions("cdnname-filter", [...uniqueCols[9]]);
        fillSelectOptions("cdntype-filter", [...uniqueCols[10]]);
        fillSelectOptions("port-filter", [...uniqueCols[11]]);
        fillSelectOptions("url-filter", [...uniqueCols[12]]);
        fillSelectOptions("screenshot-filter", [...uniqueCols[13]]);
        fillSelectOptions("redirect-filter", [...uniqueCols[14]]);
        fillSelectOptions("title-filter", [...uniqueCols[15]]);
        fillSelectOptions("webserver-filter", [...uniqueCols[16]]);
        fillSelectOptions("login-filter", [...uniqueCols[17]]);
        fillSelectOptions("api-endpoint-filter", [...uniqueCols[18]]);
        fillSelectOptions("tech-filter", [...uniqueCols[19]]);
        fillSelectOptions("statuscode-filter", [...uniqueCols[20]]);
        fillSelectOptions("contentlength-filter", [...uniqueCols[21]]);
        fillSelectOptions("cdn-filter", [...uniqueCols[22]]);
        fillSelectOptions("spf-filter", [...uniqueCols[23]]);
        fillSelectOptions("dkim-filter", [...uniqueCols[24]]);
        fillSelectOptions("dmarc-filter", [...uniqueCols[25]]);
        fillSelectOptions("dnssec-filter", [...uniqueCols[26]]);
        fillSelectOptions("sslversion-filter", [...uniqueCols[27]]);
        fillSelectOptions("certexpiry-filter", [...uniqueCols[28]]);
        fillSelectOptions("sslissuer-filter", [...uniqueCols[29]]);
        fillSelectOptions("sts-filter", [...uniqueCols[30]]);
        fillSelectOptions("xfo-filter", [...uniqueCols[31]]);
        fillSelectOptions("csp-filter", [...uniqueCols[32]]);
        fillSelectOptions("xss-filter", [...uniqueCols[33]]);
        fillSelectOptions("rp-filter", [...uniqueCols[34]]);
        fillSelectOptions("pp-filter", [...uniqueCols[35]]);
        fillSelectOptions("ports-services-filter", [...uniqueCols[36]]);
        fillSelectOptions("crawledlinks-filter", [...uniqueCols[37]]);
      }

      document.getElementById("searchBox").addEventListener("input", onFilterChange);
      document.getElementById("rowsPerPageSelect").addEventListener("change", updateRowsPerPage);
      document.getElementById("riskSortToggle").addEventListener("click", function() {
        riskSortOrder = (riskSortOrder === "asc") ? "desc" : "asc";
        this.textContent = (riskSortOrder === "asc") ? "▲" : "▼";
        renderTable(getFilteredRows());
      });

      // Async data loading and report building
      async function loadData() {
        try {
